{% extends 'base.html' %}
{% load static %}

{% block title %}Your Recommendations - Virtual Fitting System{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <!-- Success Header -->
    <div class="text-center mb-12">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-green-100 rounded-full mb-4">
            <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
            </svg>
        </div>
        <h1 class="text-4xl font-bold text-gray-900 mb-2">Scan Complete!</h1>
        <p class="text-xl text-gray-600">Here are your personalized recommendations</p>
    </div>

    <!-- Measurements Card -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Your Measurements</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-6">
            <div class="text-center p-4 bg-indigo-50 rounded-xl">
                <p class="text-sm text-gray-600 mb-1">Height</p>
                <p class="text-2xl font-bold text-indigo-600">{{ body_scan.height }} cm</p>
            </div>
            <div class="text-center p-4 bg-purple-50 rounded-xl">
                <p class="text-sm text-gray-600 mb-1">Chest</p>
                <p class="text-2xl font-bold text-purple-600">{{ body_scan.chest }} cm</p>
            </div>
            <div class="text-center p-4 bg-pink-50 rounded-xl">
                <p class="text-sm text-gray-600 mb-1">Waist</p>
                <p class="text-2xl font-bold text-pink-600">{{ body_scan.waist }} cm</p>
            </div>
            <div class="text-center p-4 bg-rose-50 rounded-xl">
                <p class="text-sm text-gray-600 mb-1">Shoulders</p>
                <p class="text-2xl font-bold text-rose-600">{{ body_scan.shoulder_width }} cm</p>
            </div>
        </div>
    </div>

    <!-- Recommendations Summary -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-gradient-to-br from-indigo-500 to-purple-600 rounded-2xl p-6 text-white">
            <h3 class="text-lg font-semibold mb-2">Recommended Size</h3>
            <p class="text-4xl font-bold">{{ recommended_size }}</p>
        </div>
        <div class="bg-gradient-to-br from-pink-500 to-rose-600 rounded-2xl p-6 text-white">
            <h3 class="text-lg font-semibold mb-2">Recommended Fit</h3>
            <p class="text-4xl font-bold capitalize">{{ recommended_fit }}</p>
        </div>
        <div class="bg-gradient-to-br from-emerald-500 to-teal-600 rounded-2xl p-6 text-white">
            <h3 class="text-lg font-semibold mb-2">Skin Tone</h3>
            <p class="text-4xl font-bold capitalize">{{ body_scan.skin_tone }}</p>
        </div>
    </div>

    <!-- Recommended Colors -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">Recommended Colors for You</h2>
        <div class="flex flex-wrap gap-4">
            {% for color in recommended_colors %}
            <div class="px-6 py-3 bg-gradient-to-r from-indigo-100 to-purple-100 rounded-full">
                <span class="font-medium text-indigo-900">{{ color }}</span>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- 3D Avatar Visualization -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-6">3D Avatar Preview</h2>
        <div id="avatar-container" class="bg-gradient-to-br from-gray-100 to-gray-200 rounded-xl"
            style="height: 500px;">
            <canvas id="avatar-canvas"></canvas>
        </div>
        <p class="text-sm text-gray-600 mt-4 text-center">
            Use your mouse to rotate and zoom the 3D model
        </p>
    </div>

    <!-- Perfect Matches For You - Actual Products with Size + Color -->
    <div class="bg-white rounded-2xl shadow-xl p-8 mb-8">
        <div class="flex items-center gap-3 mb-2">
            <span class="text-3xl">üõçÔ∏è</span>
            <h2 class="text-2xl font-bold text-gray-900">Perfect Matches For You</h2>
        </div>
        <p class="text-gray-600 mb-4">Products that fit your body and complement your skin tone</p>

        <!-- Your Recommended Fit Badge -->
        <div class="mb-4 p-3 bg-indigo-50 rounded-lg inline-flex items-center gap-2">
            <span class="text-indigo-600 font-medium">Your Recommended Fit:</span>
            <span
                class="px-3 py-1 bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-sm font-bold rounded-full capitalize">
                {{ recommended_fit|default:"Regular" }}
            </span>
        </div>


        <!-- Filter Buttons Row -->
        <div class="flex flex-wrap items-center gap-4 mb-6">
            <!-- Gender Filters -->
            <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-500">Gender:</span>
                <div class="flex gap-2">
                    <a href="?gender={% if selected_fit %}&fit={{ selected_fit }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 flex items-center gap-1 {% if not selected_gender %}bg-gradient-to-r from-indigo-600 to-purple-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üë• All
                    </a>
                    <a href="?gender=men{% if selected_fit %}&fit={{ selected_fit }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 flex items-center gap-1 {% if selected_gender == 'men' %}bg-gradient-to-r from-blue-600 to-indigo-600 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üë® Men
                    </a>
                    <a href="?gender=women{% if selected_fit %}&fit={{ selected_fit }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 flex items-center gap-1 {% if selected_gender == 'women' %}bg-gradient-to-r from-pink-500 to-rose-500 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üë© Women
                    </a>
                </div>
            </div>

            <!-- Divider -->
            <div class="hidden sm:block w-px h-8 bg-gray-300"></div>

            <!-- Fit Type Filters -->
            <div class="flex items-center gap-2">
                <span class="text-sm font-medium text-gray-500">Fit:</span>
                <div class="flex gap-2">
                    <a href="?{% if selected_gender %}gender={{ selected_gender }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 {% if not selected_fit %}bg-gradient-to-r from-emerald-500 to-teal-500 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        All Fits
                    </a>
                    <a href="?fit=slim{% if selected_gender %}&gender={{ selected_gender }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 {% if selected_fit == 'slim' %}bg-gradient-to-r from-violet-500 to-purple-500 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üëî Slim
                    </a>
                    <a href="?fit=regular{% if selected_gender %}&gender={{ selected_gender }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 {% if selected_fit == 'regular' %}bg-gradient-to-r from-blue-500 to-cyan-500 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üëï Regular
                    </a>
                    <a href="?fit=oversize{% if selected_gender %}&gender={{ selected_gender }}{% endif %}"
                        class="px-4 py-2 rounded-lg font-semibold text-sm transition-all duration-200 {% if selected_fit == 'oversize' %}bg-gradient-to-r from-orange-500 to-amber-500 text-white shadow-lg{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                        üß• Oversize
                    </a>
                </div>
            </div>
        </div>

        {% if matching_products %}
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            {% for item in matching_products %}
            <div
                class="border-2 {% if item.is_perfect_match %}border-green-300 bg-gradient-to-br from-green-50 to-emerald-50{% else %}border-gray-200 bg-white{% endif %} rounded-xl overflow-hidden hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1">

                <!-- Perfect Match Badge -->
                {% if item.is_perfect_match %}
                <div
                    class="bg-gradient-to-r from-green-500 to-emerald-500 text-white text-center py-2 text-sm font-bold flex items-center justify-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                    </svg>
                    ‚ú® Perfect Match
                </div>
                {% endif %}

                <!-- Product Image -->
                <div class="aspect-square bg-gradient-to-br from-gray-50 to-gray-100 relative overflow-hidden">
                    {% if item.product.category == 'shirt' and item.product.gender == 'men' %}
                    <img src="{% static 'images/products/mens_shirt.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% elif item.product.category == 'shirt' and item.product.gender == 'women' %}
                    <img src="{% static 'images/products/blouse.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% elif item.product.category == 'pants' or item.product.category == 'jeans' %}
                    <img src="{% static 'images/products/jeans.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% elif item.product.category == 'dress' %}
                    <img src="{% static 'images/products/womens_dress.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% elif item.product.category == 'jacket' %}
                    <img src="{% static 'images/products/jacket.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% else %}
                    <img src="{% static 'images/products/mens_shirt.png' %}" alt="{{ item.product.name }}"
                        class="w-full h-full object-cover">
                    {% endif %}

                    <!-- Fit Type Badge -->
                    <div class="absolute top-3 right-3">
                        <span
                            class="px-3 py-1 bg-white/90 backdrop-blur-sm text-indigo-700 text-xs font-semibold rounded-full shadow">
                            {{ item.fit_type|title }} Fit
                        </span>
                    </div>
                </div>

                <!-- Product Info -->
                <div class="p-5">
                    <h3 class="font-bold text-lg text-gray-900 mb-4">{{ item.product.name }}</h3>

                    <!-- Size Recommendation -->
                    <div class="flex items-center gap-3 mb-3">
                        <span
                            class="w-10 h-10 bg-indigo-100 rounded-full flex items-center justify-center flex-shrink-0">
                            <svg class="w-5 h-5 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M5 13l4 4L19 7"></path>
                            </svg>
                        </span>
                        <div>
                            <span class="text-sm text-gray-600">Your Size</span>
                            <p class="font-bold text-indigo-600 text-xl">{{ item.recommended_size }}</p>
                        </div>
                    </div>

                    <!-- Color Recommendation -->
                    <div class="flex items-center gap-3 mb-4">
                        <span class="w-10 h-10 rounded-full border-3 border-white shadow-md flex-shrink-0"
                            style="background-color: {{ item.color_hex }};"></span>
                        <div>
                            <span class="text-sm text-gray-600">Your Color</span>
                            <p class="font-bold text-purple-600">{{ item.recommended_color }}</p>
                        </div>
                    </div>

                    <!-- Price -->
                    <div
                        class="text-3xl font-extrabold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent mb-4">
                        ${{ item.product.price }}
                    </div>

                    <!-- Fit Message -->
                    <div
                        class="{% if item.is_perfect_match %}bg-green-100 border border-green-200{% else %}bg-indigo-50 border border-indigo-100{% endif %} rounded-lg p-3 mb-4">
                        <p
                            class="text-sm {% if item.is_perfect_match %}text-green-700{% else %}text-indigo-700{% endif %} italic flex items-start gap-2">
                            <span class="text-lg">üí¨</span>
                            <span>"{{ item.fit_message }}"</span>
                        </p>
                    </div>

                    <!-- Actions -->
                    <a href="{% url 'fitting_system:product_detail' item.product.id %}"
                        class="block w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white text-center py-3 rounded-xl font-bold hover:shadow-lg transition transform hover:scale-105">
                        View Product Details
                    </a>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-12 bg-gray-50 rounded-xl">
            <svg class="w-20 h-20 text-gray-300 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5"
                    d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                </path>
            </svg>
            <p class="text-gray-600 text-lg font-medium">No matching products in stock right now</p>
            <p class="text-gray-500 mt-2">Check back later or browse our full catalog below</p>
        </div>
        {% endif %}
    </div>

    <!-- Action Buttons -->
    <div class="flex gap-4 justify-center">
        <a href="{% url 'fitting_system:store' %}"
            class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition transform hover:scale-105">
            Browse All Products
        </a>
        <a href="{% url 'fitting_system:scan' %}"
            class="bg-gray-500 text-white px-8 py-4 rounded-lg font-bold text-lg hover:shadow-lg transition">
            Scan Another Customer
        </a>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Three.js for 3D Avatar -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // Simple 3D Avatar using Three.js
    let scene, camera, renderer, avatar;

    function init3DAvatar() {
        const container = document.getElementById('avatar-container');
        const canvas = document.getElementById('avatar-canvas');

        // Scene
        scene = new THREE.Scene();
        scene.background = new THREE.Color(0xf3f4f6);

        // Camera
        camera = new THREE.PerspectiveCamera(75, container.clientWidth / container.clientHeight, 0.1, 1000);
        camera.position.z = 5;

        // Renderer
        renderer = new THREE.WebGLRenderer({ canvas: canvas, antialias: true });
        renderer.setSize(container.clientWidth, container.clientHeight);

        // Lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
        scene.add(ambientLight);

        const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight.position.set(5, 10, 7.5);
        scene.add(directionalLight);

        // Create simple avatar
        createAvatar();

        // Animation loop
        animate();

        // Handle window resize
        window.addEventListener('resize', onWindowResize);

        // Mouse controls
        let mouseDown = false;
        let mouseX = 0;
        let mouseY = 0;

        canvas.addEventListener('mousedown', (e) => {
            mouseDown = true;
            mouseX = e.clientX;
            mouseY = e.clientY;
        });

        canvas.addEventListener('mouseup', () => {
            mouseDown = false;
        });

        canvas.addEventListener('mousemove', (e) => {
            if (mouseDown && avatar) {
                const deltaX = e.clientX - mouseX;
                const deltaY = e.clientY - mouseY;

                avatar.rotation.y += deltaX * 0.01;
                avatar.rotation.x += deltaY * 0.01;

                mouseX = e.clientX;
                mouseY = e.clientY;
            }
        });
    }

    function createAvatar() {
        avatar = new THREE.Group();

        // Get measurements from page
        const height = parseFloat('{{ body_scan.height }}') || 170;
        const chest = parseFloat('{{ body_scan.chest }}') || 90;
        const waist = parseFloat('{{ body_scan.waist }}') || 75;
        const shoulder = parseFloat('{{ body_scan.shoulder_width }}') || 45;

        // Normalize measurements (scale to reasonable 3D sizes)
        const scale = 0.02;
        const bodyHeight = height * scale;
        const bodyWidth = chest * scale * 0.5;
        const waistWidth = waist * scale * 0.5;

        // Head
        const headGeometry = new THREE.SphereGeometry(0.3, 32, 32);
        const skinMaterial = new THREE.MeshPhongMaterial({ color: 0xffdbac });
        const head = new THREE.Mesh(headGeometry, skinMaterial);
        head.position.y = bodyHeight * 0.45;
        avatar.add(head);

        // Torso
        const torsoGeometry = new THREE.CylinderGeometry(waistWidth, bodyWidth, bodyHeight * 0.4, 32);
        const shirtMaterial = new THREE.MeshPhongMaterial({ color: 0x6366f1 });
        const torso = new THREE.Mesh(torsoGeometry, shirtMaterial);
        torso.position.y = bodyHeight * 0.15;
        avatar.add(torso);

        // Legs
        const legGeometry = new THREE.CylinderGeometry(0.15, 0.15, bodyHeight * 0.4, 32);
        const pantsMaterial = new THREE.MeshPhongMaterial({ color: 0x1f2937 });

        const leftLeg = new THREE.Mesh(legGeometry, pantsMaterial);
        leftLeg.position.set(-0.3, -bodyHeight * 0.2, 0);
        avatar.add(leftLeg);

        const rightLeg = new THREE.Mesh(legGeometry, pantsMaterial);
        rightLeg.position.set(0.3, -bodyHeight * 0.2, 0);
        avatar.add(rightLeg);

        // Arms
        const armGeometry = new THREE.CylinderGeometry(0.1, 0.1, bodyHeight * 0.35, 32);

        const leftArm = new THREE.Mesh(armGeometry, shirtMaterial);
        leftArm.position.set(-bodyWidth - 0.2, bodyHeight * 0.15, 0);
        leftArm.rotation.z = 0.3;
        avatar.add(leftArm);

        const rightArm = new THREE.Mesh(armGeometry, shirtMaterial);
        rightArm.position.set(bodyWidth + 0.2, bodyHeight * 0.15, 0);
        rightArm.rotation.z = -0.3;
        avatar.add(rightArm);

        scene.add(avatar);
    }

    function animate() {
        requestAnimationFrame(animate);

        // Slow rotation
        if (avatar) {
            avatar.rotation.y += 0.005;
        }

        renderer.render(scene, camera);
    }

    function onWindowResize() {
        const container = document.getElementById('avatar-container');
        camera.aspect = container.clientWidth / container.clientHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(container.clientWidth, container.clientHeight);
    }

    // Initialize when page loads
    document.addEventListener('DOMContentLoaded', init3DAvatar);
</script>
{% endblock %}